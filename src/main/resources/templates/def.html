<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Публикации</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link href="https://getbootstrap.com/docs/4.0/examples/signin/signin.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          crossorigin="anonymous">
</head>
<body>


<table id="myTable">
    <tr>
        <th>Заголовок</th>
        <th>Содержание</th>
        <th style="width: 250px">Фото</th>
        <th style="width: 200px">Действие</th>
    </tr>
</table>


<div id="form" style="max-width: none">
    <h2 class="form-signin-heading">Работа с публикациями</h2>
    <p>
        <label for="headline" class="sr-only">Headline</label>
        <input type="text" id="headline" name="headline" class="form-control" placeholder="Заголовок" required=""
               autofocus="">
    </p>
    <p>
        <label for="content" class="sr-only">Content</label>
        <input style="min-height: 400px" type="text" id="content" name="content" class="form-control"
               placeholder="Текст" required="">
    </p>
    <div>

        <label>Фотография: </label>
        <input id="imgInp" type="file" name="image" accept="image/png, image/jpeg"/>
        <img src="#" id="blah" alt="your image" width="650px" height="400px"/>

    </div>
    <button id="create" class="btn btn-lg btn-primary btn-block"
            style="background-color: #313072; cursor: pointer; max-width: 200px" onclick="pubCreation()">Сохранить
    </button>

    <button id="edit" class="btn btn-lg btn-primary btn-block"
            style="display: none;background-color: #313072; cursor: pointer; max-width: 200px" onclick="editionSave()">
        Изменить
    </button>

    <button id="cancel" class="btn btn-lg  btn-block"
            style="display: none;background-color: white; cursor: pointer; max-width: 200px" onclick="cancel()">
        Отмена
    </button>
</div>


<script>
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#blah').attr('src', e.target.result);
            };
            reader.readAsDataURL(input.files[0]); // convert to base64 string
        }
    }

    $("#imgInp").change(function () {
        readURL(this);
    });
</script>


<script>

    var table = document.getElementById("myTable");
    var originalHTML = table.innerHTML;

    async function getPrivet() {
        const url = 'http://localhost:8080/getPubs';
        let response = await fetch(url);
        let text = await response.text();
        var table = document.getElementById("myTable");
        table.innerHTML = originalHTML;
        for (let item of JSON.parse(text)) {
            let i = 1;
            var row = table.insertRow(i);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            cell1.innerHTML = item.headline;
            cell2.innerHTML = item.content;
            cell3.innerHTML = "<img  width=\"200px\" height=\"150px\" src='" + item.image + "'>";
            cell4.innerHTML = "<i style='display:inline-block;min-width: 20px; min-height: 20px; cursor: pointer' onclick='pubEdition(" + JSON.stringify(item) + ")' title='Изменить' class='fa fa-edit'></i>" +
                " " +
                "<i style='display:inline-block;min-width: 20px; min-height: 20px; cursor: pointer' onclick='pubDeletion(" + JSON.stringify(item) + ")' title='Удалить' class='fa fa-close'></i>";
            i++;
        }
    }

    let trigger = getPrivet();

</script>

<script>

    let id;

    function pubEdition(item) {
        id = item.id;
        document.getElementById("headline").value = item.headline;
        document.getElementById("content").value = item.content;
        document.getElementById("blah").src = item.image;
        document.getElementById("create").style.display = "none";
        document.getElementById("edit").style.display = "inline";
        document.getElementById("cancel").style.display = "inline";
    }

    function cancel() {
        id = undefined;
        document.getElementById("create").style.display = "inline";
        document.getElementById("edit").style.display = "none";
        document.getElementById("cancel").style.display = "none";
        document.getElementById("headline").value = "";
        document.getElementById("content").value = "";
        document.getElementById("blah").src = "#";
    }

    async function editionSave() {

        const url = 'http://localhost:8080/pubs/editPub';

        data = {
            headline: document.getElementById("headline").value,
            content: document.getElementById("content").value,
            image: document.getElementById("blah").src,
            id: id,
        };

        let response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            await getPrivet();
            cancel();
            alert("Публикация изменена");
        } else {
            alert("Ошибка HTTP: " + response.status);
        }

    }

    async function pubDeletion(item) {

        let confirmed = confirm("Уверены, что хотите удалить публикацию с заголовком: " + item.headline + "?");
        if (confirmed) {
            const url = 'http://localhost:8080/pubs/deletePub?id=' + item.id;
            let response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8',
                    'Accept': 'application/json'
                },
            });

            if (response.ok) {
                await getPrivet();
                alert("Публикация удалена");
            } else {
                alert("Ошибка HTTP: " + response.status);
            }
        }
    }

    async function pubCreation() {

        const url = 'http://localhost:8080/pubs/addPub';

        data = {
            headline: document.getElementById("headline").value,
            content: document.getElementById("content").value,
            image: document.getElementById("blah").src
        };

        let response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        });


        if (response.ok) {
            await getPrivet();
            document.getElementById("headline").value = "";
            document.getElementById("content").value = "";
            document.getElementById("blah").src = "#";
            alert("Публикация сохранена");
        } else {
            alert("Ошибка HTTP: " + response.status);
        }
    }

</script>

</body>

<style>
    #myTable {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    #myTable td, #myTable th {
        border: 1px solid #ddd;
        padding: 8px;
    }

    #myTable tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #myTable tr:hover {
        background-color: #ddd;
    }

    #myTable th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #313072;
        color: white;
    }
</style>
</html>

